


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Uncertain Inputs with Gaussian Processes">
      
      
        <link rel="canonical" href="https://jejjohnson.github.io/uncertain_gps/notebooks/kernel_derivatives/">
      
      
        <meta name="author" content="J. Emmanuel Johnson">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.4">
    
    
      
        <title>Kernel derivatives - Uncertain Gaussian Processes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.c4007cdc.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.8435c73a.min.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=source+code+pro:300,400,400i,700%7Csource+code+pro&display=fallback">
        <style>body,input{font-family:"source code pro",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"source code pro",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="gray">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kernel-derivatives" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://jejjohnson.github.io/uncertain_gps" title="Uncertain Gaussian Processes" class="md-header-nav__button md-logo" aria-label="Uncertain Gaussian Processes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Uncertain Gaussian Processes
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Kernel derivatives
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/jejjohnson/uncertain_gps/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jejjohnson/uncertain_gps
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://jejjohnson.github.io/uncertain_gps" title="Uncertain Gaussian Processes" class="md-nav__button md-logo" aria-label="Uncertain Gaussian Processes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Uncertain Gaussian Processes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jejjohnson/uncertain_gps/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jejjohnson/uncertain_gps
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Input Uncertainty for Gaussian Processes" class="md-nav__link">
      Input Uncertainty for Gaussian Processes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../basics/" title="Gaussian Process Basics" class="md-nav__link">
      Gaussian Process Basics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../error_propagation/" title="Error Propagation" class="md-nav__link">
      Error Propagation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../literature/" title="Uncertain Inputs in Gaussian Processes" class="md-nav__link">
      Uncertain Inputs in Gaussian Processes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../mm/" title="Moment-Matching" class="md-nav__link">
      Moment-Matching
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../next/" title="Next Steps" class="md-nav__link">
      Next Steps
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../software/" title="Software" class="md-nav__link">
      Software
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../stochastic/" title="Stochastic" class="md-nav__link">
      Stochastic
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../taylor/" title="Linearization (Taylor Expansions)" class="md-nav__link">
      Linearization (Taylor Expansions)
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../uncertainty/" title="What is Uncertainty?" class="md-nav__link">
      What is Uncertainty?
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vi/" title="Uncertain Inputs GPs - Variational Strategies" class="md-nav__link">
      Uncertain Inputs GPs - Variational Strategies
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12" checked>
    
    <label class="md-nav__link" for="nav-12">
      Notebooks
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Notebooks" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Notebooks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../1.0_gp_basics/" title="1.0 gp basics" class="md-nav__link">
      1.0 gp basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../distances/" title="Distances" class="md-nav__link">
      Distances
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../egp_pyro_svgp/" title="Egp pyro svgp" class="md-nav__link">
      Egp pyro svgp
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../egp_pyro_vgp/" title="Egp pyro vgp" class="md-nav__link">
      Egp pyro vgp
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kernel derivatives
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Kernel derivatives" class="md-nav__link md-nav__link--active">
      Kernel derivatives
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paper-idea" class="md-nav__link">
    Paper Idea
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-function" class="md-nav__link">
    Kernel Function
  </a>
  
    <nav class="md-nav" aria-label="Kernel Function">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rbf-kernel" class="md-nav__link">
    RBF Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-matrix" class="md-nav__link">
    Kernel Matrix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-cross-covariance-term-1st-derivative" class="md-nav__link">
    1. Cross-Covariance Term - 1st Derivative
  </a>
  
    <nav class="md-nav" aria-label="1. Cross-Covariance Term - 1st Derivative">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-sample" class="md-nav__link">
    Single Sample
  </a>
  
    <nav class="md-nav" aria-label="Single Sample">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-dimensions" class="md-nav__link">
    Multiple Dimensions
  </a>
  
    <nav class="md-nav" aria-label="Multiple Dimensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_1" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_1" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-samples-batches" class="md-nav__link">
    Multiple Samples (Batches)
  </a>
  
    <nav class="md-nav" aria-label="Multiple Samples (Batches)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_2" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_2" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-cross-covariance-term-2nd-derivative" class="md-nav__link">
    2. Cross-Covariance Term - 2nd Derivative
  </a>
  
    <nav class="md-nav" aria-label="2. Cross-Covariance Term - 2nd Derivative">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_3" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_3" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-cross-covariance-term-2nd-derivative-partial-derivatives" class="md-nav__link">
    3. Cross-Covariance Term - 2nd Derivative (Partial Derivatives)
  </a>
  
    <nav class="md-nav" aria-label="3. Cross-Covariance Term - 2nd Derivative (Partial Derivatives)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_4" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_4" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../numpyro_egp_mcmc/" title="Numpyro egp mcmc" class="md-nav__link">
      Numpyro egp mcmc
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Talks
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Talks" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Talks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../talks/2020_kermes/" title="KERMES Meetup 2020" class="md-nav__link">
      KERMES Meetup 2020
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paper-idea" class="md-nav__link">
    Paper Idea
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-function" class="md-nav__link">
    Kernel Function
  </a>
  
    <nav class="md-nav" aria-label="Kernel Function">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rbf-kernel" class="md-nav__link">
    RBF Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-matrix" class="md-nav__link">
    Kernel Matrix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-cross-covariance-term-1st-derivative" class="md-nav__link">
    1. Cross-Covariance Term - 1st Derivative
  </a>
  
    <nav class="md-nav" aria-label="1. Cross-Covariance Term - 1st Derivative">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-sample" class="md-nav__link">
    Single Sample
  </a>
  
    <nav class="md-nav" aria-label="Single Sample">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-dimensions" class="md-nav__link">
    Multiple Dimensions
  </a>
  
    <nav class="md-nav" aria-label="Multiple Dimensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_1" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_1" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-samples-batches" class="md-nav__link">
    Multiple Samples (Batches)
  </a>
  
    <nav class="md-nav" aria-label="Multiple Samples (Batches)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_2" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_2" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-cross-covariance-term-2nd-derivative" class="md-nav__link">
    2. Cross-Covariance Term - 2nd Derivative
  </a>
  
    <nav class="md-nav" aria-label="2. Cross-Covariance Term - 2nd Derivative">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_3" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_3" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-cross-covariance-term-2nd-derivative-partial-derivatives" class="md-nav__link">
    3. Cross-Covariance Term - 2nd Derivative (Partial Derivatives)
  </a>
  
    <nav class="md-nav" aria-label="3. Cross-Covariance Term - 2nd Derivative (Partial Derivatives)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-scratch_4" class="md-nav__link">
    From Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax_4" class="md-nav__link">
    Jax
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jejjohnson/uncertain_gps/edit/master/docs/notebooks/kernel_derivatives.ipynb" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script>
(function() {
  function addWidgetsRenderer() {
    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var scriptElement = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    scriptElement.src = widgetRendererSrc;
    document.body.appendChild(scriptElement);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h1 id="kernel-derivatives">Kernel Derivatives<a class="headerlink" href="#kernel-derivatives" title="Permanent link">&para;</a></h1>
<p><strong>Resources</strong></p>
<ul>
<li><a href="http://mlg.eng.cam.ac.uk/mchutchon/DifferentiatingGPs.pdf">Differentating Gaussian Processes</a> - Andrew McHutchen</li>
</ul>
<h2 id="paper-idea">Paper Idea<a class="headerlink" href="#paper-idea" title="Permanent link">&para;</a></h2>
<p><strong>Linear Operators and Stochastic Partial Differential Equations in GPR</strong> - Simo Särkkä - <a href="https://users.aalto.fi/~ssarkka/pub/spde.pdf">PDF</a></p>
<blockquote>
<p>Expresses derivatives of GPs as operators</p>
</blockquote>
<p><a href="https://colab.research.google.com/drive/1pbb0qlypJCqPTN_cu2GEkkKLNXCYO9F2"><strong>Demo Colab Notebook</strong></a></p>
<p>He looks at ths special case where we have a GP with a mean function zero and a covariance matrix <span><span class="MathJax_Preview">K</span><script type="math/tex">K</script></span> defined as:
$$
\mathbb{E}[f(\mathbf{x})f^\top(\mathbf{x'})] = K_{ff}(\mathbf{x,x'})
$$
So in GP terminology:
$$
f(\mathbf(x)) \sim \mathcal{GP}(\mathbf{0}, K_{ff}(\mathbf{x,x'}))
$$
We use the rulse for linear transformations of GPs to obtain the different transformations of the kernel matrix. </p>
<p>Let's define the notation for the derivative of a kernel matrix. Let <span><span class="MathJax_Preview">g(\cdot)</span><script type="math/tex">g(\cdot)</script></span> be the derivative operator on a function <span><span class="MathJax_Preview">f(\cdot)</span><script type="math/tex">f(\cdot)</script></span>. So:
$$
g(\mathbf{x}) = \mathcal{L}_x f(\mathbf{x})
$$</p>
<p>So now, we want to define the cross operators between the derivative <span><span class="MathJax_Preview">g(\cdot)</span><script type="math/tex">g(\cdot)</script></span> and the function <span><span class="MathJax_Preview">f(\cdot)</span><script type="math/tex">f(\cdot)</script></span>. </p>
<p><strong>Example</strong>: He draws a distinction between the two operators with an example of how this works in practice. So let's take the linear operator <span><span class="MathJax_Preview">\mathcal{L}_{x}=(1, \frac{\partial}{\partial x})</span><script type="math/tex">\mathcal{L}_{x}=(1, \frac{\partial}{\partial x})</script></span>. This operator:</p>
<ul>
<li>acts on a scalar GP <span><span class="MathJax_Preview">f(x)</span><script type="math/tex">f(x)</script></span></li>
<li>a scalar input <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span> </li>
<li>a covariance function <span><span class="MathJax_Preview">k_{ff}(x,x')</span><script type="math/tex">k_{ff}(x,x')</script></span> </li>
<li>outputs a scalar value <span><span class="MathJax_Preview">y</span><script type="math/tex">y</script></span></li>
</ul>
<p>We can get the following transformations:
$$
\begin{aligned}
K_{gf}(\mathbf{x,x'})
&amp;= \mathcal{L}<em ff="ff">x f(\mathbf{x}) f(\mathbf{x}) = \mathcal{L}_xK</em>(\mathbf{x,x'}) \
K_{fg}(\mathbf{x,x'})
&amp;= f(\mathbf{x}) f(\mathbf{x'}) \mathcal{L}<em ff="ff">{x'} = K</em>(\mathbf{x,x'})\mathcal{L}<em gg="gg">{x'} \
K</em>(\mathbf{x,x'})
&amp;= \mathcal{L}<em x_="x'">x f(\mathbf{x}) f(\mathbf{x'}) \mathcal{L}</em>
= \mathcal{L}<em ff="ff">xK</em>(\mathbf{x,x'})\mathcal{L}_{x'}^\top \
\end{aligned}
$$
</div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1">#@title Packages</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">onp</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">rbf_kernel</span> <span class="k">as</span> <span class="n">rbf_sklearn</span>
<span class="c1"># Plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">([</span><span class="s1">&#39;seaborn-paper&#39;</span><span class="p">])</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1">#@title Plot Functions</span>

<span class="k">def</span> <span class="nf">plot_kernel_mat</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="c1"># plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$K_</span><span class="si">{ff}</span><span class="s1">$, (rbf)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1">#@title Data</span>

<span class="k">def</span> <span class="nf">get_1d_data</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">N_test</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="c1"># Y = X + 0.2 * np.power(X, 3.0) + 0.5 * np.power(0.5 + X, 2.0) * np.sin(4.0 * X)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1.6</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">X</span><span class="p">))</span>
    <span class="n">Y</span> <span class="o">+=</span> <span class="n">sigma_obs</span> <span class="o">*</span> <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">+=</span> <span class="n">sigma_inputs</span> <span class="o">*</span> <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">-=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">/=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>



    <span class="n">X_test</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">N_test</span><span class="p">)</span> 
    <span class="n">X_test</span> <span class="o">+=</span> <span class="n">sigma_inputs</span> <span class="o">*</span> <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N_test</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span>

<span class="k">def</span> <span class="nf">get_2d_data</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">N_test</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="c1"># Y = X + 0.2 * np.power(X, 3.0) + 0.5 * np.power(0.5 + X, 2.0) * np.sin(4.0 * X)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1.6</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">X1</span><span class="p">))</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X2</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">+=</span> <span class="n">sigma_obs</span> <span class="o">*</span> <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">-=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">/=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>



    <span class="n">X1_test</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">N_test</span><span class="p">)</span>
    <span class="n">X2_test</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">N_test</span><span class="p">)</span> 

    <span class="n">X</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">X1</span><span class="p">,</span><span class="n">X2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">X1_test</span><span class="p">,</span><span class="n">X2_test</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span>

<span class="c1"># Get Data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">get_1d_data</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">N_test</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/emmanuel/.conda/envs/jax_py38/lib/python3.8/site-packages/jax/lib/xla_bridge.py:123: UserWarning: No GPU/TPU found, falling back to CPU.
  warnings.warn(&#39;No GPU/TPU found, falling back to CPU.&#39;)
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h2 id="kernel-function">Kernel Function<a class="headerlink" href="#kernel-function" title="Permanent link">&para;</a></h2>
<p></div>
</div></p>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1">#@title Kernel Functions</span>

<span class="c1"># Squared Euclidean Distance Formula</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">sqeuclidean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># RBF Kernel</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">rbf_kernel</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sqeuclidean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="c1"># Covariance Matrix</span>
<span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="n">kernel_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">mapx1</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">kernel_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mapx2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mapx1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mapx2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="rbf-kernel">RBF Kernel<a class="headerlink" href="#rbf-kernel" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">get_2d_data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">test_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">test_Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">rbf_x_sk</span> <span class="o">=</span> <span class="n">rbf_sklearn</span><span class="p">(</span>
    <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
    <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
    <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rbf_x_sk</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;var_f&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
<span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">rbf_k_</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">rbf_x</span> <span class="o">=</span> <span class="n">rbf_k_</span><span class="p">(</span>
    <span class="n">test_X</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> 
    <span class="n">test_Y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbf_x</span><span class="p">),</span> <span class="n">rbf_x_sk</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stdout output_text">
<pre>(1, 1) (1, 2)
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h3 id="kernel-matrix">Kernel Matrix<a class="headerlink" href="#kernel-matrix" title="Permanent link">&para;</a></h3>
</div>
</div>
<p>We defined all of our functions above with only dimensions in mind, not the number of samples or the batch size. So we need to account for that. So if we wanted to calculate the kernel matrix, we would have to loop through all of the samples and calculate the products individually, which would take a long time; especially for large amounts of data. </p>
<blockquote>
<p>Avoid Loops at all cost in python...</p>
</blockquote>
<p>Fortunately, Jax has this incredible function <code>vmap</code> which handles batching automatically at apparently, no extra cost. So we can write our functions to account for vectors without having to care about the batch size and then use the <code>vmap</code> function to essentially "vectorize" our functions. It essentially allows us to take a product between a matrix and a sample or two vectors of multiple samples. Let's go through an example of how we can construct our kernel matrix.</p>
<ol>
<li>We need to map all points with one vector to another.</li>
</ol>
<p>We're going to take a single sample from <span><span class="MathJax_Preview">X'</span><script type="math/tex">X'</script></span> and take the rbf kernel between it and all of <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span>. So:</p>
<div>
<div class="MathJax_Preview">\text{vmap}_f(\mathbf{X}, \mathbf{x})</div>
<script type="math/tex; mode=display">\text{vmap}_f(\mathbf{X}, \mathbf{x})</script>
</div>
<p>where <span><span class="MathJax_Preview">X\in \mathbb{R}^{N \times D}</span><script type="math/tex">X\in \mathbb{R}^{N \times D}</script></span> is a matrix and <span><span class="MathJax_Preview">\mathbf{x} \in \mathbb{R}^{D}</span><script type="math/tex">\mathbf{x} \in \mathbb{R}^{D}</script></span> is a vector.
</div>
</div></p>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># Gram Matrix</span>
<span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x1</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y1</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))(</span><span class="n">y</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># map function 1</span>
<span class="n">mapx1</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">rbf_kernel</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># test the mapping</span>
<span class="n">x1_mapped</span> <span class="o">=</span> <span class="n">mapx1</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>

<span class="c1"># Check output shapes, # of dimensions</span>
<span class="k">assert</span> <span class="n">x1_mapped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   
<span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x1_mapped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>   
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1">
This that's good: we have an array of size <span><span class="MathJax_Preview">N</span><script type="math/tex">N</script></span>. So we've effectively mapped all points from one array to the other.</p>
<p>So now we can do another vector mapping which allows us to take all samples of <span><span class="MathJax_Preview">X'</span><script type="math/tex">X'</script></span> and map them against all samples of <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span>. So it'll be a <code>vmap</code> of a <code>vmap</code>. Then we'll get the <span><span class="MathJax_Preview">N\times N</span><script type="math/tex">N\times N</script></span> kernel matrix.
</div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">mapx2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mapx1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">K</span> <span class="o">=</span> <span class="n">mapx2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

<span class="c1"># Check output shapes, # of dimensions</span>
<span class="k">assert</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   
<span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>     

<span class="n">rbf_x_sk</span> <span class="o">=</span> <span class="n">rbf_sklearn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>


<span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbf_x_sk</span><span class="p">),</span> <span class="n">K</span><span class="p">)</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1">
So great! We now have our kernel matrix. Let's plot it and check to see if it matches the manually constructed kernel matrix.</p>
<p>Great! We have a vectorized kernel function and we were still able to construct our functions in terms of vectors only! This is nice for me personally because I've always struggled with understanding some of the coding when trying to deal with samples/batch-sizes. Most pseudo-code is written in vector format so paper <span><span class="MathJax_Preview">\rightarrow</span><script type="math/tex">\rightarrow</script></span> has always been a painful transition for me. So now, let's wrap this in a nice function so that we can finish "wrap up" this model.
</div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">get_2d_data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">test_X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="c1">#[:2, :]</span>
<span class="n">test_Y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#[:2, :]</span>

<span class="n">rbf_x_sk</span> <span class="o">=</span> <span class="n">rbf_sklearn</span><span class="p">(</span>
    <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_X</span><span class="p">),</span> 
    <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_Y</span><span class="p">),</span> 
    <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;var_f&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
<span class="n">rbf_k_</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">rbf_x</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span>
    <span class="n">rbf_k_</span><span class="p">,</span>
    <span class="n">test_X</span><span class="p">,</span> 
    <span class="n">test_Y</span>
<span class="p">)</span>

<span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbf_x</span><span class="p">),</span> <span class="n">rbf_x_sk</span><span class="p">)</span>

<span class="n">plot_kernel_mat</span><span class="p">(</span><span class="n">rbf_x</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">


<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1">#@title Tests</span>

<span class="n">kx</span> <span class="o">=</span> <span class="n">rbf_kernel</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># check, the output should be 1.0</span>
<span class="k">assert</span> <span class="n">kx</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">kx</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">kx</span> <span class="o">=</span> <span class="n">rbf_kernel</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># check, the output should NOT be 1.0</span>
<span class="k">assert</span> <span class="n">kx</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">kx</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1"># dk_dx = drbf_kernel(gamma, X[0], X[0])</span>

<span class="c1"># # check, the output should be 0.0</span>
<span class="c1"># assert dk_dx == 0.0, f&quot;Output: {dk_dx}&quot;</span>

<span class="c1"># dk_dx = drbf_kernel(gamma, X[0], X[1])</span>

<span class="c1"># # check, the output should NOT be 0.0</span>
<span class="c1"># assert dk_dx != 0.0, f&quot;Output: {dk_dx}&quot;</span>
</code></pre></div>

</div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1">#@title Speed Test</span>

<span class="c1"># Covariance Matrix</span>
<span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="n">kernel_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">mapx1</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">kernel_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mapx2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mapx1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mapx2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x1</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y1</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))(</span><span class="n">x</span><span class="p">))(</span><span class="n">y</span><span class="p">)</span>

<span class="n">rbf_K</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">rbf_cov</span> <span class="o">=</span>  <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">rbf_K</span><span class="p">))</span>
<span class="n">rbf_x</span> <span class="o">=</span> <span class="n">rbf_cov</span><span class="p">(</span><span class="n">test_X</span><span class="p">,</span>  <span class="n">test_Y</span><span class="p">)</span>


<span class="n">rbf_cov2</span> <span class="o">=</span>  <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">gram</span><span class="p">,</span> <span class="n">rbf_K</span><span class="p">))</span>
<span class="n">rbf_x2</span> <span class="o">=</span> <span class="n">rbf_cov2</span><span class="p">(</span><span class="n">test_X</span><span class="p">,</span>  <span class="n">test_Y</span><span class="p">)</span>

<span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbf_x</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbf_x2</span><span class="p">))</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">timeit</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rbf_cov</span><span class="p">(</span><span class="n">test_X</span><span class="p">,</span>  <span class="n">test_Y</span><span class="p">)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rbf_cov2</span><span class="p">(</span><span class="n">test_X</span><span class="p">,</span>  <span class="n">test_Y</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stdout output_text">
<pre>182 µs ± 20.8 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
167 µs ± 941 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h2 id="1-cross-covariance-term-1st-derivative">1. Cross-Covariance Term - 1<sup>st</sup> Derivative<a class="headerlink" href="#1-cross-covariance-term-1st-derivative" title="Permanent link">&para;</a></h2>
</div>
</div>
<p>We can calculate the cross-covariance term <span><span class="MathJax_Preview">K_{fg}(\mathbf{x,x})</span><script type="math/tex">K_{fg}(\mathbf{x,x})</script></span>. We apply the following operation</p>
<div>
<div class="MathJax_Preview">
K_{fg}(x,x') = k_{ff}(\mathbf{x,x'})(1, \frac{\partial}{\partial x'})
$$
If we multiply the terms across, we get:
$$
K_{fg}(x,x') = k_{ff}(\mathbf{x,x'})\frac{\partial k_{ff}(\mathbf{x,x'})}{\partial x'}
</div>
<script type="math/tex; mode=display">
K_{fg}(x,x') = k_{ff}(\mathbf{x,x'})(1, \frac{\partial}{\partial x'})
$$
If we multiply the terms across, we get:
$$
K_{fg}(x,x') = k_{ff}(\mathbf{x,x'})\frac{\partial k_{ff}(\mathbf{x,x'})}{\partial x'}
</script>
</div>
<p>For the RBF Kernel, it's this:</p>
<div>
<div class="MathJax_Preview">\frac{\partial k(x,y)}{\partial x^j}=-2 \gamma (x^j - y^j) k(x,y)</div>
<script type="math/tex; mode=display">\frac{\partial k(x,y)}{\partial x^j}=-2 \gamma (x^j - y^j) k(x,y)</script>
</div>
</div>
</div>


<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h3 id="single-sample">Single Sample<a class="headerlink" href="#single-sample" title="Permanent link">&para;</a></h3>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">get_1d_data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">test_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">test_Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="from-scratch">From Scratch<a class="headerlink" href="#from-scratch" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">drbf_kernel_scratch</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">dK_fg_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">constant</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gamma</span>

    <span class="n">k_val</span> <span class="o">=</span> <span class="n">rbf_sklearn</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

        <span class="n">x_val</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">]</span>

        <span class="n">dK_fg_</span><span class="p">[</span><span class="n">idim</span><span class="p">]</span> <span class="o">=</span> <span class="n">constant</span> <span class="o">*</span> <span class="n">k_val</span> <span class="o">*</span>  <span class="n">x_val</span> 
    <span class="k">return</span> <span class="n">dK_fg_</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">dK_fg_</span> <span class="o">=</span> <span class="n">drbf_kernel_scratch</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_Y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dK_fg_</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.01392619]
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="jax">Jax<a class="headerlink" href="#jax" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># define the cross operator K_fg(x, y), dK wrt x</span>
<span class="n">drbf_kernel_fg</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># calculate for a single sample</span>
<span class="n">dK_fg</span> <span class="o">=</span> <span class="n">drbf_kernel_fg</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">test_X</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">test_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dK_fg</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.01392619]
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h3 id="multiple-dimensions">Multiple Dimensions<a class="headerlink" href="#multiple-dimensions" title="Permanent link">&para;</a></h3>
<p></div>
</div></p>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">get_2d_data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">test_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">test_Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="from-scratch_1">From Scratch<a class="headerlink" href="#from-scratch_1" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">dK_fg_</span> <span class="o">=</span> <span class="n">drbf_kernel_scratch</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_Y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dK_fg_</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.0173953  0.00608835]
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="jax_1">Jax<a class="headerlink" href="#jax_1" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># define the cross operator K_fg(x, y), dK wrt x</span>
<span class="n">drbf_kernel_fg</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># calculate for a single sample</span>
<span class="n">dK_fg</span> <span class="o">=</span> <span class="n">drbf_kernel_fg</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">test_X</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">test_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dK_fg</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.0173953  0.00608835]
</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h3 id="multiple-samples-batches">Multiple Samples (Batches)<a class="headerlink" href="#multiple-samples-batches" title="Permanent link">&para;</a></h3>
<p></div>
</div></p>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">get_2d_data</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma_obs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">test_X</span> <span class="o">=</span> <span class="n">X</span>
<span class="n">test_Y</span> <span class="o">=</span> <span class="n">X</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="from-scratch_2">From Scratch<a class="headerlink" href="#from-scratch_2" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">dK_fg_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">dK_fg_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">drbf_kernel_scratch</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_Y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="jax_2">Jax<a class="headerlink" href="#jax_2" title="Permanent link">&para;</a></h4>
</div>
</div>


</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># define the cross operator K_fg(x, y), dK wrt x</span>
<span class="n">drbf_kernel_fg</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">K_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">drbf_kernel_fg</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">dK_fg</span> <span class="o">=</span> <span class="n">gram</span><span class="p">(</span><span class="n">K_func</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_Y</span><span class="p">)</span>


<span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dK_fg</span><span class="p">),</span> <span class="n">dK_fg_</span><span class="p">)</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h2 id="2-cross-covariance-term-2nd-derivative">2. Cross-Covariance Term - 2<sup>nd</sup> Derivative<a class="headerlink" href="#2-cross-covariance-term-2nd-derivative" title="Permanent link">&para;</a></h2>
<p>$$
\frac{\partial^2 k(x,y)}{\partial x<sup>{j</sup>2}} =
2 \gamma \left[ 2\gamma(x^j - y<sup>j)</sup>2 - 1\right] k(\mathbf{x}, \mathbf{y})
$$
</div>
</div></p>
</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="from-scratch_3">From Scratch<a class="headerlink" href="#from-scratch_3" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">d2rbf_kernel_scratch_jac</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">d2K_fg2_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">constant</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gamma</span>

    <span class="n">k_val</span> <span class="o">=</span> <span class="n">rbf_sklearn</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

        <span class="n">x_val</span> <span class="o">=</span> <span class="n">constant</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">d2K_fg2_</span><span class="p">[</span><span class="n">idim</span><span class="p">]</span> <span class="o">=</span> <span class="n">constant</span> <span class="o">*</span> <span class="n">k_val</span> <span class="o">*</span>  <span class="n">x_val</span> 
    <span class="k">return</span> <span class="n">d2K_fg2_</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">d2K_fg2_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">d2K_fg2_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">d2rbf_kernel_scratch_jac</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_Y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="jax_3">Jax<a class="headerlink" href="#jax_3" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># define the cross operator K_fg(x, y), dK wrt x</span>
<span class="n">dK_fg_func</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">K_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">dK_fg_func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">d2K_fg2</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span><span class="n">K_func</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_Y</span><span class="p">)</span>

<span class="n">d2K_fg2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">d2K_fg2</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">d2K_fg2</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">


<div class="output_text output_subarea output_execute_result">
<pre>(10, 10, 2)</pre>
</div>

</div>

</div>
</div>

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2K_fg2</span><span class="p">),</span> <span class="n">d2K_fg2_</span><span class="p">)</span>
</code></pre></div>

</div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h2 id="3-cross-covariance-term-2nd-derivative-partial-derivatives">3. Cross-Covariance Term - 2<sup>nd</sup> Derivative (Partial Derivatives)<a class="headerlink" href="#3-cross-covariance-term-2nd-derivative-partial-derivatives" title="Permanent link">&para;</a></h2>
<p>$$
\frac{\partial^2 k(x,y)}{\partial x^j \partial y^k} =
4 \gamma^2 (x^k - y<sup>k)(x</sup>j - y^j) k(\mathbf{x}, \mathbf{y})
$$
</div>
</div></p>
</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="from-scratch_4">From Scratch<a class="headerlink" href="#from-scratch_4" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">d2rbf_kernel_scratch_hessian</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">d2K_fg2_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">constant</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gamma</span>
    <span class="n">constant_sq</span> <span class="o">=</span> <span class="n">constant</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">k_val</span> <span class="o">=</span> <span class="n">rbf_sklearn</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">jdim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="n">x_val</span> <span class="o">=</span> <span class="n">constant</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">constant</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">idim</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">jdim</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">jdim</span><span class="p">]))</span><span class="c1"># - constant</span>

            <span class="n">d2K_fg2_</span><span class="p">[</span><span class="n">idim</span><span class="p">,</span> <span class="n">jdim</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_val</span> <span class="o">*</span>  <span class="n">x_val</span> 
    <span class="k">return</span> <span class="n">d2K_fg2_</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">d2K_fg2_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">d2K_fg2_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2rbf_kernel_scratch_hessian</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_Y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<p><div class="inner_cell" markdown="1">
<div class="text_cell_render border-box-sizing rendered_html" markdown="1"></p>
<h4 id="jax_4">Jax<a class="headerlink" href="#jax_4" title="Permanent link">&para;</a></h4>
<p></div>
</div></p>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># define the cross operator K_fg(x, y), dK wrt x</span>
<span class="n">dK_fg_func</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">rbf_kernel</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">K_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">dK_fg_func</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">d2K_fg2</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span><span class="n">K_func</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_Y</span><span class="p">)</span>

<span class="n">d2K_fg2</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">


<div class="output_text output_subarea output_execute_result">
<pre>(10, 10, 2, 2)</pre>
</div>

</div>

</div>
</div>

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">d2K_fg2</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">3</span> <span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">d2K_fg2</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>

</div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">onp</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2K_fg2</span><span class="p">),</span> <span class="n">d2K_fg2_</span><span class="p">)</span>
</code></pre></div>

</div>

<div class="output_wrapper" markdown="1">
<div class="output" markdown="1">


<div class="output_area" markdown="1">
<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AssertionError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-67-a1b4fece15e3&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>onp<span class="ansi-blue-fg">.</span>testing<span class="ansi-blue-fg">.</span>assert_array_almost_equal<span class="ansi-blue-fg">(</span>onp<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>d2K_fg2<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> d2K_fg2_<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.conda/envs/jax_py38/lib/python3.8/site-packages/numpy/testing/_private/utils.py</span> in <span class="ansi-cyan-fg">assert_array_almost_equal</span><span class="ansi-blue-fg">(x, y, decimal, err_msg, verbose)</span>
<span class="ansi-green-intense-fg ansi-bold">   1043</span>         <span class="ansi-green-fg">return</span> z <span class="ansi-blue-fg">&lt;</span> <span class="ansi-cyan-fg">1.5</span> <span class="ansi-blue-fg">*</span> <span class="ansi-cyan-fg">10.0</span><span class="ansi-blue-fg">**</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">-</span>decimal<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1044</span> 
<span class="ansi-green-fg">-&gt; 1045</span><span class="ansi-red-fg">     assert_array_compare(compare, x, y, err_msg=err_msg, verbose=verbose,
</span><span class="ansi-green-intense-fg ansi-bold">   1046</span>              header<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Arrays are not almost equal to %d decimals&#39;</span> <span class="ansi-blue-fg">%</span> decimal<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">   1047</span>              precision=decimal)

<span class="ansi-green-fg">~/.conda/envs/jax_py38/lib/python3.8/site-packages/numpy/testing/_private/utils.py</span> in <span class="ansi-cyan-fg">assert_array_compare</span><span class="ansi-blue-fg">(comparison, x, y, err_msg, verbose, header, precision, equal_nan, equal_inf)</span>
<span class="ansi-green-intense-fg ansi-bold">    844</span>                                 verbose<span class="ansi-blue-fg">=</span>verbose<span class="ansi-blue-fg">,</span> header<span class="ansi-blue-fg">=</span>header<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    845</span>                                 names=(&#39;x&#39;, &#39;y&#39;), precision=precision)
<span class="ansi-green-fg">--&gt; 846</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> AssertionError<span class="ansi-blue-fg">(</span>msg<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    847</span>     <span class="ansi-green-fg">except</span> ValueError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    848</span>         <span class="ansi-green-fg">import</span> traceback

<span class="ansi-red-fg">AssertionError</span>: 
Arrays are not almost equal to 6 decimals

Mismatched elements: 112 / 400 (28%)
Max absolute difference: 4.
Max relative difference: 2.40703559
 x: array([[[[-2.000000e+00,  0.000000e+00],
         [ 0.000000e+00, -2.000000e+00]],
...
 y: array([[[[ 2.000000e+00,  2.000000e+00],
         [ 2.000000e+00,  2.000000e+00]],
...</pre>
</div>
</div>

</div>
</div>

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>
</code></pre></div>

</div>

</div>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../egp_pyro_vgp/" title="Egp pyro vgp" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Egp pyro vgp
              </div>
            </div>
          </a>
        
        
          <a href="../numpyro_egp_mcmc/" title="Numpyro egp mcmc" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Numpyro egp mcmc
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 J. Emmanuel Johnson
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="https://github.com/jejjohnson" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
      <a href="https://twitter.com/jejjohnson" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
      <a href="https://linkedin.com/in/jejjohnson" target="_blank" rel="noopener" title="linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
      
      
      <a href="https://jejjohnson.netlify.com" target="_blank" rel="noopener" title="jejjohnson.netlify.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.83fe6e3c.min.js"></script>
      <script src="../../assets/javascripts/bundle.7e1cb91c.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../javascripts/extra.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  </body>
</html>